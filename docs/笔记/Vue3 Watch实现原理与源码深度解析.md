# Vue3 Watchå®žçŽ°åŽŸç†ä¸Žæºç æ·±åº¦è§£æž

## ðŸ“– æ¦‚è¿°

`watch` æ˜¯ Vue3 å“åº”å¼ç³»ç»Ÿä¸­çš„æ ¸å¿ƒ APIï¼Œå®ƒå…è®¸å¼€å‘è€…åœ¨å“åº”å¼æ•°æ®å‘ç”Ÿå˜åŒ–æ—¶æ‰§è¡Œç‰¹å®šçš„å‰¯ä½œç”¨ï¼ˆside effectsï¼‰ã€‚æœ¬æ–‡æ¡£æ·±å…¥è§£æž `watch` çš„å®žçŽ°åŽŸç†ï¼Œä»ŽåŸºç¡€å®žçŽ°åˆ°é«˜çº§é…ç½®é€‰é¡¹ï¼Œå…¨é¢å‰–æžå…¶è®¾è®¡æ€æƒ³å’ŒæŠ€æœ¯ç»†èŠ‚ã€‚

## ðŸŽ¯ æ ¸å¿ƒè®¾è®¡ç†å¿µ

### 1. åŸºäºŽ Effect çš„è°ƒåº¦æœºåˆ¶

`watch` æœ¬è´¨ä¸Šæ˜¯ `effect` çš„ä¸€ç§ç‰¹æ®Šåº”ç”¨ï¼š

- **effect**ï¼šå½“æ•°æ®å‘ç”Ÿå˜åŒ–æ—¶ï¼Œé‡æ–°æ‰§è¡Œè‡ªèº«
- **watch**ï¼šå½“æ•°æ®å‘ç”Ÿå˜åŒ–æ—¶ï¼Œä¸æ‰§è¡Œè‡ªèº«ï¼Œè€Œæ˜¯è°ƒç”¨ç”¨æˆ·æä¾›çš„å›žè°ƒå‡½æ•°

è¿™ç§è®¾è®¡é€šè¿‡è°ƒåº¦å™¨ï¼ˆSchedulerï¼‰æœºåˆ¶å®žçŽ°ï¼Œå½“å“åº”å¼æ•°æ®å˜æ›´æ—¶ï¼Œä¸ç›´æŽ¥é‡æ–°æ‰§è¡Œ `effect` ä¸»ä½“å‡½æ•°ï¼Œè€Œæ˜¯æ‰§è¡ŒæŒ‡å®šçš„è°ƒåº¦å‡½æ•°ã€‚

### 2. ç›‘å¬æºçš„å¤šæ ·æ€§

`watch` æ”¯æŒå¤šç§ç±»åž‹çš„ç›‘å¬æºï¼š
- **ref å¯¹è±¡**ï¼šç›‘å¬ `ref.value` çš„å˜åŒ–
- **reactive å¯¹è±¡**ï¼šç›‘å¬æ•´ä¸ªå“åº”å¼å¯¹è±¡çš„å˜åŒ–
- **getter å‡½æ•°**ï¼šç›‘å¬å‡½æ•°è¿”å›žå€¼çš„å˜åŒ–
- **æ•°ç»„**ï¼šåŒæ—¶ç›‘å¬å¤šä¸ªæºçš„å˜åŒ–

## ðŸ”§ åŸºç¡€å®žçŽ°åŽŸç†

### 1. æ ¸å¿ƒæž¶æž„è®¾è®¡

```typescript
export function watch(source, cb, options) {
  let getter 
  
  // æ ¹æ® source ç±»åž‹åˆ›å»ºå¯¹åº”çš„ getter
  if(isRef(source)) {
    getter = () => source.value
  } else if(isReactive(source)) {
    getter = () => source
    if(!deep) deep = true  // reactive é»˜è®¤æ·±åº¦ç›‘å¬
  } else if(isFunction(source)) {
    getter = source
  }
  
  let oldValue
  
  // è°ƒåº¦å‡½æ•°ï¼šæ•°æ®å˜åŒ–æ—¶çš„æ‰§è¡Œé€»è¾‘
  function job() {
    const newValue = effect.run()  // èŽ·å–æ–°å€¼
    cb(newValue, oldValue)         // æ‰§è¡Œç”¨æˆ·å›žè°ƒ
    oldValue = newValue            // æ›´æ–°æ—§å€¼
  }
  
  // åˆ›å»º ReactiveEffect å®žä¾‹
  const effect = new ReactiveEffect(getter)
  effect.scheduler = job
  
  // åˆå§‹åŒ–ï¼šæ”¶é›†ä¾èµ–å¹¶èŽ·å–åˆå§‹å€¼
  oldValue = effect.run()
  
  // è¿”å›žåœæ­¢å‡½æ•°
  return () => effect.stop()
}
```

### 2. ä¸ºä»€ä¹ˆä½¿ç”¨ ReactiveEffect è€Œä¸æ˜¯ effect å‡½æ•°ï¼Ÿ

å…³é”®åŽŸå› æ˜¯**è¿”å›žå€¼èŽ·å–**ï¼š
- `effect` å‡½æ•°è¿”å›žçš„æ˜¯ `runner`ï¼Œæ— æ³•ç›´æŽ¥èŽ·å–å†…éƒ¨ `fn` çš„è¿”å›žå€¼
- `ReactiveEffect` å®žä¾‹å¯ä»¥é€šè¿‡ `effect.run()` ç›´æŽ¥èŽ·å¾—è¿”å›žå€¼

è¿™å¯¹äºŽ `watch` èŽ·å–æ–°æ—§å€¼è‡³å…³é‡è¦ã€‚

### 3. ä¾èµ–æ”¶é›†ä¸Žè°ƒåº¦æµç¨‹

#### åˆå§‹åŒ–é˜¶æ®µ
1. åˆ›å»º `ReactiveEffect` å®žä¾‹ï¼Œä¼ å…¥ `getter` å‡½æ•°
2. è®¾ç½® `scheduler` ä¸º `job` å‡½æ•°
3. æ‰§è¡Œ `effect.run()` è¿›è¡Œä¾èµ–æ”¶é›†å¹¶èŽ·å–åˆå§‹å€¼
4. å°†åˆå§‹å€¼å­˜å‚¨ä¸º `oldValue`

#### æ›´æ–°é˜¶æ®µ
1. ç›‘å¬çš„å“åº”å¼æ•°æ®å‘ç”Ÿå˜åŒ–
2. è§¦å‘ä¾èµ–æ›´æ–°ï¼Œæ‰§è¡Œ `scheduler`ï¼ˆå³ `job` å‡½æ•°ï¼‰
3. `job` å‡½æ•°è°ƒç”¨ `effect.run()` èŽ·å–æ–°å€¼
4. æ‰§è¡Œç”¨æˆ·å›žè°ƒ `cb(newValue, oldValue)`
5. æ›´æ–° `oldValue = newValue`

### 4. åœæ­¢ç›‘å¬æœºåˆ¶

```typescript
// ReactiveEffect ç±»ä¸­çš„ stop æ–¹æ³•
export class ReactiveEffect implements Sub {
  active = true
  
  run() {
    if(!this.active) {
      return this.fn()  // ä¸æ”¶é›†ä¾èµ–ï¼Œåªè¿”å›žå€¼
    }
    // ... æ­£å¸¸çš„ä¾èµ–æ”¶é›†é€»è¾‘
  }
  
  stop() {
    if(this.active) {
      startTrack(this)   // å¼€å§‹æ¸…ç†
      endTrack(this)     // æ¸…é™¤æ‰€æœ‰ä¾èµ–
      this.active = false // æ ‡è®°ä¸ºéžæ´»è·ƒ
    }
  }
}
```

åœæ­¢ç›‘å¬çš„æ ¸å¿ƒæ˜¯ï¼š
1. æ¸…ç†å½“å‰ `effect` æ”¶é›†çš„æ‰€æœ‰ä¾èµ–å…³ç³»
2. è®¾ç½® `active = false`ï¼ŒåŽç»­ `run()` ä¸å†æ”¶é›†ä¾èµ–
3. å½»åº•æ–­å¼€ä¸Žå“åº”å¼æ•°æ®çš„è¿žæŽ¥

## âš™ï¸ é«˜çº§é…ç½®é€‰é¡¹

### 1. immediate - ç«‹å³æ‰§è¡Œ

```typescript
if(immediate) {
  job()  // ç«‹å³æ‰§è¡Œä¸€æ¬¡ï¼ŒoldValue ä¸º undefined
} else {
  oldValue = effect.run()  // åªæ”¶é›†ä¾èµ–ï¼Œä¸æ‰§è¡Œå›žè°ƒ
}
```

**å®žçŽ°åŽŸç†**ï¼š
- `immediate: true` æ—¶ï¼Œåˆå§‹åŒ–åŽç«‹å³è°ƒç”¨ `job()` å‡½æ•°
- æ­¤æ—¶ `oldValue` ä¸º `undefined`ï¼Œ`newValue` ä¸ºå½“å‰å€¼
- `immediate: false` æ—¶ï¼Œåªè¿›è¡Œä¾èµ–æ”¶é›†ï¼Œä¸è§¦å‘å›žè°ƒ

### 2. once - å•æ¬¡æ‰§è¡Œ

```typescript
if(once) {
  const _cb = cb
  cb = (...args) => {
    _cb(...args)  // æ‰§è¡ŒåŽŸå§‹å›žè°ƒ
    stop()        // ç«‹å³åœæ­¢ç›‘å¬
  }
}
```

**å®žçŽ°åŽŸç†**ï¼š
- åŒ…è£…ç”¨æˆ·çš„åŽŸå§‹å›žè°ƒå‡½æ•°
- åœ¨æ‰§è¡Œå®Œç”¨æˆ·å›žè°ƒåŽï¼Œç«‹å³è°ƒç”¨ `stop()` åœæ­¢ç›‘å¬
- ç¡®ä¿å›žè°ƒåªæ‰§è¡Œä¸€æ¬¡

### 3. deep - æ·±åº¦ç›‘å¬

#### åŸºç¡€æ·±åº¦ç›‘å¬

```typescript
if(deep) {
  const baseGetter = getter
  getter = () => traverse(baseGetter())
}

function traverse(value, seen = new Set()) {
  if(!isObject(value)) return value
  if(seen.has(value)) return value  // é˜²æ­¢å¾ªçŽ¯å¼•ç”¨
  
  seen.add(value)
  for(const key in value) {
    traverse(value[key], seen)  // é€’å½’è®¿é—®æ‰€æœ‰å±žæ€§
  }
  return value
}
```

**å®žçŽ°åŽŸç†**ï¼š
- åœ¨ä¾èµ–æ”¶é›†é˜¶æ®µï¼Œé€’å½’è®¿é—®å¯¹è±¡çš„æ‰€æœ‰åµŒå¥—å±žæ€§
- è®¿é—®æ—¶è§¦å‘ getterï¼Œå°†æ‰€æœ‰æ·±å±‚å±žæ€§éƒ½æ”¶é›†ä¸ºä¾èµ–
- ä½¿ç”¨ `Set` è®°å½•å·²è®¿é—®å¯¹è±¡ï¼Œé¿å…å¾ªçŽ¯å¼•ç”¨å¯¼è‡´çš„é€’å½’çˆ†æ ˆ

#### å±‚çº§æŽ§åˆ¶ï¼ˆVue 3.5 æ–°ç‰¹æ€§ï¼‰

```typescript
if(deep) {
  const baseGetter = getter
  const depth = deep === true ? Infinity : deep
  getter = () => traverse(baseGetter(), depth)
}

function traverse(value, depth = Infinity, seen = new Set()) {
  if(!isObject(value) || depth <= 0) return value
  if(seen.has(value)) return value
  
  seen.add(value)
  depth--  // é€’å‡æ·±åº¦
  
  for(const key in value) {
    traverse(value[key], depth, seen)
  }
  return value
}
```

**å±‚çº§æŽ§åˆ¶ç‰¹æ€§**ï¼š
- `deep: true` â†’ æ— é™æ·±åº¦ç›‘å¬
- `deep: 2` â†’ åªç›‘å¬åˆ°ç¬¬äºŒå±‚
- è¶…å‡ºæŒ‡å®šå±‚çº§çš„å±žæ€§å˜åŒ–ä¸ä¼šè§¦å‘å›žè°ƒ

### 4. å¤šç§ Source ç±»åž‹å¤„ç†

```typescript
// å®Œæ•´çš„ source ç±»åž‹åˆ¤æ–­é€»è¾‘
if(isRef(source)) {
  getter = () => source.value
} else if(isReactive(source)) {
  getter = () => source
  if(!deep) deep = true  // reactive é»˜è®¤æ·±åº¦ç›‘å¬
} else if(isFunction(source)) {
  getter = source
} else if(isArray(source)) {
  // å¤šæºç›‘å¬ï¼ˆç®€åŒ–ç‰ˆï¼‰
  getter = () => source.map(s => isRef(s) ? s.value : s)
}
```

**è®¾è®¡è€ƒè™‘**ï¼š
- **ref**ï¼šç›‘å¬ `.value` å±žæ€§çš„å˜åŒ–
- **reactive**ï¼šé»˜è®¤å¼€å¯æ·±åº¦ç›‘å¬ï¼Œå› ä¸º reactive å¯¹è±¡é€šå¸¸éœ€è¦ç›‘å¬å†…éƒ¨å±žæ€§
- **function**ï¼šç›´æŽ¥ä½œä¸º getterï¼Œç›‘å¬å‡½æ•°è¿”å›žå€¼çš„å˜åŒ–
- **array**ï¼šæ”¯æŒåŒæ—¶ç›‘å¬å¤šä¸ªæº

## ðŸš€ æ€§èƒ½ä¼˜åŒ–ç­–ç•¥

### 1. æƒ°æ€§è®¡ç®—
- åªæœ‰åœ¨æ•°æ®çœŸæ­£å˜åŒ–æ—¶æ‰æ‰§è¡Œå›žè°ƒ
- é€šè¿‡è°ƒåº¦å™¨æœºåˆ¶é¿å…ä¸å¿…è¦çš„è®¡ç®—

### 2. ä¾èµ–ç²¾ç¡®æ”¶é›†
- åªæ”¶é›†å®žé™…è®¿é—®çš„å±žæ€§ä½œä¸ºä¾èµ–
- é¿å…è¿‡åº¦ä¾èµ–å¯¼è‡´çš„æ€§èƒ½é—®é¢˜

### 3. æ·±åº¦ç›‘å¬ä¼˜åŒ–
- å±‚çº§æŽ§åˆ¶å‡å°‘ä¸å¿…è¦çš„æ·±å±‚éåŽ†
- å¾ªçŽ¯å¼•ç”¨æ£€æµ‹é¿å…æ— é™é€’å½’

### 4. å†…å­˜ç®¡ç†
- æä¾› `stop` æ–¹æ³•ä¸»åŠ¨æ¸…ç†ä¾èµ–
- é˜²æ­¢å†…å­˜æ³„æ¼

## ðŸ“Š å®Œæ•´æ‰§è¡Œæµç¨‹ç¤ºä¾‹

```typescript
// ç¤ºä¾‹ä»£ç 
const count = ref(0)
const stop = watch(count, (newVal, oldVal) => {
  console.log('count changed:', newVal, oldVal)
}, { immediate: true })

// æ‰§è¡Œæµç¨‹åˆ†æž
```

### åˆå§‹åŒ–é˜¶æ®µ
1. **åˆ›å»º getter**ï¼š`() => count.value`
2. **åˆ›å»º ReactiveEffect**ï¼šä¼ å…¥ getter å‡½æ•°
3. **è®¾ç½®è°ƒåº¦å™¨**ï¼š`effect.scheduler = job`
4. **immediate æ‰§è¡Œ**ï¼šç«‹å³è°ƒç”¨ `job()`
   - `newValue = effect.run()` â†’ 0
   - `cb(0, undefined)` â†’ è¾“å‡º "count changed: 0 undefined"
   - `oldValue = 0`

### æ•°æ®æ›´æ–°é˜¶æ®µ
```typescript
count.value = 1  // è§¦å‘æ›´æ–°
```

1. **è§¦å‘ä¾èµ–**ï¼š`count.value` çš„ setter è¢«è°ƒç”¨
2. **æ‰§è¡Œè°ƒåº¦å™¨**ï¼šè°ƒç”¨ `job` å‡½æ•°è€Œä¸æ˜¯é‡æ–°æ‰§è¡Œ effect
3. **èŽ·å–æ–°å€¼**ï¼š`effect.run()` â†’ 1
4. **æ‰§è¡Œå›žè°ƒ**ï¼š`cb(1, 0)` â†’ è¾“å‡º "count changed: 1 0"
5. **æ›´æ–°æ—§å€¼**ï¼š`oldValue = 1`

### åœæ­¢ç›‘å¬
```typescript
stop()  // è°ƒç”¨è¿”å›žçš„åœæ­¢å‡½æ•°
```

1. **æ¸…ç†ä¾èµ–**ï¼šè°ƒç”¨ `effect.stop()`
2. **æ ‡è®°éžæ´»è·ƒ**ï¼š`effect.active = false`
3. **æ–­å¼€è¿žæŽ¥**ï¼šåŽç»­æ•°æ®å˜åŒ–ä¸å†è§¦å‘å›žè°ƒ

## ðŸ” ä¸Žå…¶ä»–å“åº”å¼ API çš„å…³ç³»

### watch vs effect
- **effect**ï¼šè‡ªåŠ¨é‡æ–°æ‰§è¡Œï¼Œç”¨äºŽå‰¯ä½œç”¨
- **watch**ï¼šæ‰§è¡Œç”¨æˆ·å›žè°ƒï¼Œç”¨äºŽç›‘å¬å˜åŒ–

### watch vs computed
- **computed**ï¼šè®¡ç®—å±žæ€§ï¼Œæœ‰ç¼“å­˜ï¼Œè¿”å›žè®¡ç®—ç»“æžœ
- **watch**ï¼šç›‘å¬å™¨ï¼Œæ— è¿”å›žå€¼ï¼Œæ‰§è¡Œå‰¯ä½œç”¨

### watch vs watchEffect
- **watch**ï¼šéœ€è¦æ˜Žç¡®æŒ‡å®šç›‘å¬æºï¼Œå¯èŽ·å–æ–°æ—§å€¼
- **watchEffect**ï¼šè‡ªåŠ¨æ”¶é›†ä¾èµ–ï¼Œç±»ä¼¼ effect ä½†æ”¯æŒå¼‚æ­¥

## ðŸ’¡ æœ€ä½³å®žè·µå»ºè®®

### 1. é€‰æ‹©åˆé€‚çš„ç›‘å¬æºç±»åž‹
```typescript
// âœ… æŽ¨èï¼šæ˜Žç¡®çš„ç›‘å¬ç›®æ ‡
watch(() => user.name, (newName) => {
  // åªç›‘å¬ name å±žæ€§
})

// âŒ é¿å…ï¼šè¿‡åº¦ç›‘å¬
watch(user, (newUser) => {
  // ç›‘å¬æ•´ä¸ªå¯¹è±¡çš„æ‰€æœ‰å˜åŒ–
}, { deep: true })
```

### 2. åˆç†ä½¿ç”¨ deep é€‰é¡¹
```typescript
// âœ… æŽ¨èï¼šæŒ‡å®šç›‘å¬æ·±åº¦
watch(state, callback, { deep: 2 })

// âœ… æŽ¨èï¼šåªç›‘å¬éœ€è¦çš„å±žæ€§
watch(() => state.user.profile.name, callback)
```

### 3. åŠæ—¶æ¸…ç†ç›‘å¬å™¨
```typescript
// âœ… æŽ¨èï¼šç»„ä»¶å¸è½½æ—¶æ¸…ç†
onUnmounted(() => {
  stop()
})

// âœ… æŽ¨èï¼šæ¡ä»¶æ€§åœæ­¢
if (someCondition) {
  stop()
}
```

### 4. é¿å…åœ¨å›žè°ƒä¸­ä¿®æ”¹ç›‘å¬çš„æ•°æ®
```typescript
// âŒ é¿å…ï¼šå¯èƒ½å¯¼è‡´æ— é™å¾ªçŽ¯
watch(count, (newVal) => {
  count.value = newVal + 1  // å±é™©ï¼
})

// âœ… æŽ¨èï¼šä½¿ç”¨å…¶ä»–æ•°æ®æˆ–æ·»åŠ æ¡ä»¶åˆ¤æ–­
watch(count, (newVal) => {
  if (newVal < 10) {
    otherValue.value = newVal + 1
  }
})
```

## ðŸŽ‰ æ€»ç»“

Vue3 çš„ `watch` å®žçŽ°å±•çŽ°äº†å“åº”å¼ç³»ç»Ÿçš„ç²¾å¦™è®¾è®¡ï¼š

1. **æž¶æž„æ¸…æ™°**ï¼šåŸºäºŽ `ReactiveEffect` å’Œè°ƒåº¦å™¨çš„è®¾è®¡ï¼ŒèŒè´£åˆ†ç¦»æ˜Žç¡®
2. **åŠŸèƒ½å®Œå¤‡**ï¼šæ”¯æŒå¤šç§ç›‘å¬æºç±»åž‹å’Œä¸°å¯Œçš„é…ç½®é€‰é¡¹
3. **æ€§èƒ½ä¼˜åŒ–**ï¼šæƒ°æ€§è®¡ç®—ã€ç²¾ç¡®ä¾èµ–æ”¶é›†ã€å±‚çº§æŽ§åˆ¶ç­‰ä¼˜åŒ–ç­–ç•¥
4. **æ˜“äºŽä½¿ç”¨**ï¼šç®€æ´çš„ API è®¾è®¡ï¼Œå¼ºå¤§çš„åŠŸèƒ½æ”¯æŒ

é€šè¿‡æ·±å…¥ç†è§£ `watch` çš„å®žçŽ°åŽŸç†ï¼Œæˆ‘ä»¬å¯ä»¥æ›´å¥½åœ°ï¼š
- é€‰æ‹©åˆé€‚çš„ç›‘å¬ç­–ç•¥
- é¿å…å¸¸è§çš„æ€§èƒ½é™·é˜±
- ç¼–å†™æ›´é«˜æ•ˆçš„å“åº”å¼ä»£ç 
- ç†è§£ Vue3 å“åº”å¼ç³»ç»Ÿçš„è®¾è®¡å“²å­¦

è¿™ç§"æŽ¨æ‹‰ç»“åˆ"çš„è®¾è®¡æ¨¡å¼ï¼ˆæŽ¨é€å˜åŒ–é€šçŸ¥ + æ‹‰å–æœ€æ–°å€¼ï¼‰ä¸ä»…ä¿è¯äº†å“åº”æ€§çš„æ­£ç¡®æ€§ï¼Œä¹Ÿå®žçŽ°äº†æ€§èƒ½çš„æœ€ä¼˜åŒ–ï¼Œæ˜¯çŽ°ä»£å‰ç«¯æ¡†æž¶å“åº”å¼ç³»ç»Ÿçš„å…¸åž‹ä»£è¡¨ã€‚

---

*æœ¬æ–‡æ¡£åŸºäºŽ Vue3 å“åº”å¼ç³»ç»Ÿçš„å­¦ä¹ å®žè·µï¼Œæ·±å…¥åˆ†æžäº† watch çš„å®žçŽ°ç»†èŠ‚å’Œè®¾è®¡æ€æƒ³ï¼Œä¸ºæ·±å…¥ç†è§£ Vue3 æä¾›å‚è€ƒã€‚*